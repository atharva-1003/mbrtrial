name: Gemini Auto Fix Agent

on:
  workflow_dispatch:
    inputs:
      issue_key:
        required: true
      issue_summary:
        required: true
      issue_description:
        required: true

jobs:
  auto-fix:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Fix Branch
        run: |
          BRANCH_NAME="fix/issue-${{ github.event.inputs.issue_key }}"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Install jq
        run: sudo apt-get install jq -y

      # ðŸ”¥ STEP 1: Read Actual File
      - name: Read File Content
        id: readfile
        run: |
          FILE_CONTENT=$(cat src/index.js)
          echo "FILE_CONTENT<<EOF" >> $GITHUB_ENV
          echo "$FILE_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # ðŸ”¥ STEP 2: Send File + Issue to Gemini
      - name: Call Gemini API
        run: |
          ISSUE_PROMPT="You are a senior engineer.

          Fix the bug in this file.

          Issue Summary:
          ${{ github.event.inputs.issue_summary }}

          Issue Description:
          ${{ github.event.inputs.issue_description }}

          Here is the file content:

          $FILE_CONTENT

          Return ONLY the FULL corrected file content.
          Do not explain anything."

          RESPONSE=$(curl -s https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent \
            -H "Content-Type: application/json" \
            -H "X-goog-api-key: ${{ secrets.GEMINI_API_KEY }}" \
            -d "{
              \"contents\": [{
                \"parts\": [{\"text\": \"$ISSUE_PROMPT\"}]
              }]
            }")

          echo "$RESPONSE" > gemini_response.json

          FIX_CODE=$(cat gemini_response.json | jq -r '.candidates[0].content.parts[0].text')

          echo "$FIX_CODE" > src/index.js

      # ðŸ”¥ STEP 3: Commit ONLY if changed
      - name: Commit Changes
        run: |
          git config user.name "gemini-bot"
          git config user.email "bot@example.com"
          git add src/index.js

          if git diff --cached --quiet; then
            echo "No changes detected. Skipping commit."
            exit 0
          fi

          git commit -m "fix: resolve issue #${{ github.event.inputs.issue_key }}"
          git push origin $BRANCH_NAME

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          title: "AI Auto Fix: Issue #${{ github.event.inputs.issue_key }}"
          body: |
            ðŸ¤– Automatically generated fix using Gemini AI.
          branch: ${{ env.BRANCH_NAME }}
          base: main
