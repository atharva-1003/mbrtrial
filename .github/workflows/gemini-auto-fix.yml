name: Gemini Auto Fix Agent

on:
  workflow_dispatch:
    inputs:
      issue_key:
        required: true
        type: string
      issue_summary:
        required: true
        type: string
      issue_description:
        required: true
        type: string

jobs:
  auto-fix:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create fix branch
        run: |
          BRANCH_NAME="fix/issue-${{ github.event.inputs.issue_key }}"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install jq -y

      # ðŸ”¥ Read existing file
      - name: Read file content
        run: |
          FILE_PATH="src/index.js"

          if [ ! -f "$FILE_PATH" ]; then
            echo "File not found: $FILE_PATH"
            exit 1
          fi

          FILE_CONTENT=$(cat "$FILE_PATH")

          echo "FILE_PATH=$FILE_PATH" >> $GITHUB_ENV
          echo "FILE_CONTENT<<EOF" >> $GITHUB_ENV
          echo "$FILE_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # ðŸ”¥ Send issue + file to Gemini
      - name: Call Gemini API
        run: |
          PROMPT=$(cat <<EOF
You are a senior software engineer.

There is a bug in the following file.

Issue Summary:
${{ github.event.inputs.issue_summary }}

Issue Description:
${{ github.event.inputs.issue_description }}

Here is the full file content:

$FILE_CONTENT

Return ONLY the full corrected file content.
Do NOT add explanations.
EOF
)

          RESPONSE=$(curl -s https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent \
            -H "Content-Type: application/json" \
            -H "X-goog-api-key: ${{ secrets.GEMINI_API_KEY }}" \
            -d "$(jq -n --arg prompt "$PROMPT" \
              '{contents: [{parts: [{text: $prompt}]}]}')")

          FIX_CODE=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')

          if [ -z "$FIX_CODE" ]; then
            echo "Gemini returned empty response"
            echo "$RESPONSE"
            exit 1
          fi

          echo "$FIX_CODE" > $FILE_PATH

      # ðŸ”¥ Commit only if changed
      - name: Commit changes
        run: |
          git config user.name "ai-bot"
          git config user.email "bot@example.com"

          git add $FILE_PATH

          if git diff --cached --quiet; then
            echo "No changes detected"
            exit 0
          fi

          git commit -m "fix: resolve issue #${{ github.event.inputs.issue_key }}"
          git push origin $BRANCH_NAME

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          title: "AI Auto Fix: Issue #${{ github.event.inputs.issue_key }}"
          branch: ${{ env.BRANCH_NAME }}
          base: main
